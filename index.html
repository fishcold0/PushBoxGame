<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Daily Warehouse - æ¯æ—¥å€‰åº«ç•ª</title>
<style>
  /* --- åŸºç¤æ¨£å¼ --- */
  body { font-family: 'Segoe UI', sans-serif; background-color: #2c3e50; color: white; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; min-height: 100vh; margin: 0; padding-top: 20px; }
  h1 { margin: 10px 0; font-size: 24px; }
  
  /* --- èªªæ˜èˆ‡æ§åˆ¶é … --- */
  #instructions, .controls { 
      max-width: 400px; 
      padding: 10px; 
      margin-bottom: 20px;
      background: #34495e; 
      border-radius: 8px;
  }
  
  #instructions h3 { margin-top: 0; color: #f1c40f; }
  .controls { text-align: center; }
  
  button { 
      padding: 8px 16px; margin: 5px; cursor: pointer; 
      background: #e67e22; border: none; color: white; 
      border-radius: 4px; font-size: 14px; 
      transition: background 0.2s;
  }
  button:hover { background: #d35400; }
  /* ä¿®æ­£ï¼šå¢åŠ  active æ¨£å¼ */
  button.active { 
      background: #d35400; 
      border: 2px solid #fff;
  }
  
  /* --- éŠæˆ²åœ°åœ– --- */
  #game-container {
    display: grid;
    gap: 2px;
    background: #34495e;
    padding: 10px;
    border-radius: 8px;
    box-shadow: 0 10px 20px rgba(0,0,0,0.3);
  }
  
  .cell {
    width: 30px; height: 30px;
    display: flex; align-items: center; justify-content: center;
    font-size: 20px;
    border-radius: 4px;
    transition: background-color 0.1s;
  }
  
  /* åœ–å¡Šæ¨£å¼ */
  .wall { background-color: #95a5a6; } 
  .floor { background-color: #ecf0f1; } 
  .target { background-color: #e74c3c; opacity: 0.6; } 
  
  /* å¯¦é«”å±¤ (ç”¨ CSS ç–ŠåŠ åœ–ç¤º) */
  .player { position: relative; }
  .player::after { content: 'ğŸ‘·'; position: absolute; font-size: 22px; }
  
  .box { position: relative; }
  .box::after { content: 'ğŸ“¦'; position: absolute; font-size: 22px; }
  
  .box-on-target { position: relative; }
  .box-on-target::after { content: 'âœ…'; position: absolute; font-size: 22px; }

  #status { margin-top: 15px; font-weight: bold; color: #f1c40f; min-height: 24px;}
  
  /* æ‰‹æ©Ÿç‰ˆæ–¹å‘éµ */
  .d-pad { margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; }
  .d-btn { width: 50px; height: 50px; background: #7f8c8d; border-radius: 50%; font-size: 24px; display: flex; align-items: center; justify-content: center; user-select: none; cursor: pointer;}
  .d-btn:active { background: #95a5a6; }
</style>
</head>
<body>

<h1>æ¯æ—¥å€‰åº«ç•ª</h1>

<div id="instructions">
    <h3>éŠæˆ²èªªæ˜èˆ‡è¦å‰‡</h3>
    <ul>
        <li><strong>ç›®æ¨™ï¼š</strong> å°‡æ‰€æœ‰çš„ç®±å­ (ğŸ“¦) æ¨åˆ°ç›®æ¨™é» (ç´…è‰²åº• ğŸŸ¥) ä¸Šã€‚ç•¶æ‰€æœ‰ç®±å­éƒ½è®Šæˆ âœ… ç¬¦è™Ÿæ™‚ï¼Œå³å¯éé—œã€‚</li>
        <li><strong>æ§åˆ¶ï¼š</strong> ä½¿ç”¨éµç›¤æ–¹å‘éµ (â†‘â†“â†â†’) æˆ–ä¸‹æ–¹çš„ D-pad æŒ‰éˆ•ç§»å‹•å·¥äºº (ğŸ‘·)ã€‚</li>
        <li><strong>é‡è¦è¦å‰‡ï¼š</strong>
            <ul>
                <li>âŒ ä¸€æ¬¡åªèƒ½æ¨å‹•ä¸€å€‹ç®±å­ã€‚</li>
                <li>âŒ ç„¡æ³•æ¨å‹•ç®±å­ç©¿è¶Šç‰†å£ (ç°è‰²å¡Š ğŸ§±) æˆ–å¦ä¸€å€‹ç®±å­ã€‚</li>
                <li>âŒ ç„¡æ³•æ‹‰å‹•ç®±å­ã€‚</li>
            </ul>
        </li>
        <li><strong>æ¯æ—¥æŒ‘æˆ°ï¼š</strong> æ¯å¤©çš„é—œå¡é…ç½®éƒ½æ˜¯å›ºå®šçš„ï¼Œæ‚¨å¯ä»¥èˆ‡æœ‹å‹æ¯”è¼ƒæ­¥æ•¸ï¼</li>
    </ul>
</div>

<div class="controls">
  <button onclick="setDifficulty('EASY')" id="btn-easy">ç°¡æ˜“</button>
  <button onclick="setDifficulty('NORMAL')" id="btn-normal">æ™®é€š</button>
  <button onclick="setDifficulty('HARD')" id="btn-hard">å›°é›£</button>
  <button onclick="initGame()" style="background-color: #27ae60;">é‡ç½®</button>
</div>

<div id="game-container"></div>
<div id="status"></div>

<div class="d-pad">
    <div></div><div class="d-btn" onclick="movePlayer(0, -1)">â¬†ï¸</div><div></div>
    <div class="d-btn" onclick="movePlayer(-1, 0)">â¬…ï¸</div><div class="d-btn" onclick="movePlayer(0, 1)">â¬‡ï¸</div><div class="d-btn" onclick="movePlayer(1, 0)">â¡ï¸</div>
</div>

<script>
// éŠæˆ²åƒæ•¸
const LEVELS = {
    EASY: { size: 8, boxes: 2, steps: 30 },
    NORMAL: { size: 10, boxes: 3, steps: 60 },
    HARD: { size: 12, boxes: 5, steps: 120 }
};

let currentDiff = 'NORMAL';
let grid = [];
let playerPos = {x: 0, y: 0};
let mapSize = 0;
let rng; // éš¨æ©Ÿç”Ÿæˆå™¨
let moveCount = 0;

// å½éš¨æ©Ÿæ•¸ç”Ÿæˆå™¨ (ç¢ºä¿æ¯æ—¥ç›¸åŒ)
function createRNG(seed) {
    return function() {
        seed = (seed * 9301 + 49297) % 233280;
        return seed / 233280;
    };
}

// ä¿®æ­£ï¼šæ›´æ–°æŒ‰éˆ•è¦–è¦ºç‹€æ…‹
function updateDifficultyButtons() {
    ['EASY', 'NORMAL', 'HARD'].forEach(diff => {
        const btn = document.getElementById(`btn-${diff.toLowerCase()}`);
        if (btn) {
            if (diff === currentDiff) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        }
    });
}

function setDifficulty(diff) {
    currentDiff = diff;
    updateDifficultyButtons();
    initGame();
}

function initGame() {
    const today = new Date();
    // æ¯æ—¥ç¨®å­ + é›£åº¦ä¿‚æ•¸
    const seedBase = parseInt(today.getFullYear() + "" + String(today.getMonth()+1).padStart(2, '0') + "" + String(today.getDate()).padStart(2, '0'));
    const diffSeed = currentDiff === 'EASY' ? 1 : (currentDiff === 'NORMAL' ? 2 : 3);
    rng = createRNG(seedBase + diffSeed);

    generateLevel(LEVELS[currentDiff]);
    moveCount = 0;
    document.getElementById('status').innerText = `æ­¥æ•¸: ${moveCount} | Level: ${today.toLocaleDateString()} [${currentDiff}]`;
    render();
}

// æ ¸å¿ƒæ¼”ç®—æ³•ï¼šé€†å‘ç”Ÿæˆ (é‚è¼¯èˆ‡å‰æ¬¡ç‰ˆæœ¬ç›¸åŒï¼Œç¢ºä¿æœ‰è§£)
function generateLevel(config) {
    mapSize = config.size;
    grid = [];

    // 1. åˆå§‹åŒ–åœ°åœ–
    for(let y=0; y<mapSize; y++) {
        let row = [];
        for(let x=0; x<mapSize; x++) row.push('#'); 
        grid.push(row);
    }

    // 2. æŒ–å‡ºä¸€å€‹æˆ¿é–“
    let innerSize = mapSize - 2;
    for(let y=1; y<=innerSize; y++) {
        for(let x=1; x<=innerSize; x++) {
            grid[y][x] = '.'; 
        }
    }

    // 3. éš¨æ©Ÿæ”¾ç½®ç›®æ¨™é» (Targets)
    let targets = [];
    while(targets.length < config.boxes) {
        let tx = Math.floor(rng() * innerSize) + 1;
        let ty = Math.floor(rng() * innerSize) + 1;
        if(!targets.some(t => t.x === tx && t.y === ty)) {
            targets.push({x: tx, y: ty});
            grid[ty][tx] = 'T'; 
        }
    }

    // 4. æ”¾ç½®ç©å®¶ (éš¨æ©Ÿæ‰¾ç©ºåœ°)
    while(true) {
        let px = Math.floor(rng() * innerSize) + 1;
        let py = Math.floor(rng() * innerSize) + 1;
        if(grid[py][px] === '.') {
            playerPos = {x: px, y: py};
            break;
        }
    }

    // 5. åˆå§‹ç‹€æ…‹ï¼šç®±å­éƒ½åœ¨ç›®æ¨™é»ä¸Š
    let boxes = JSON.parse(JSON.stringify(targets)); 
    
    // 6. é€†å‘æ‹‰å‹• (Reverse Play)
    for(let i=0; i<config.steps; i++) {
        let boxIdx = Math.floor(rng() * boxes.length);
        let box = boxes[boxIdx];
        
        let dirs = [{x:0, y:-1}, {x:1, y:0}, {x:0, y:1}, {x:-1, y:0}];
        dirs.sort(() => rng() - 0.5);
        
        for(let d of dirs) {
            let pullDestX = box.x + d.x;
            let pullDestY = box.y + d.y;
            let playerDestX = box.x + d.x * 2;
            let playerDestY = box.y + d.y * 2;
            
            function isValid(x, y) {
                return x >= 0 && x < mapSize && y >= 0 && y < mapSize && grid[y][x] !== '#';
            }

            function isBoxAt(x, y, boxList) {
                return boxList.some(b => b.x === x && b.y === y);
            }

            if(isValid(pullDestX, pullDestY) && isValid(playerDestX, playerDestY)) {
                if(!isBoxAt(pullDestX, pullDestY, boxes) && !isBoxAt(playerDestX, playerDestY, boxes)) {
                    boxes[boxIdx].x = pullDestX;
                    boxes[boxIdx].y = pullDestY;
                    playerPos = {x: playerDestX, y: playerDestY}; 
                    break;
                }
            }
        }
    }

    window.currentBoxes = boxes;
}

function render() {
    const container = document.getElementById('game-container');
    container.innerHTML = '';
    container.style.gridTemplateColumns = `repeat(${mapSize}, 30px)`;

    for(let y=0; y<mapSize; y++) {
        for(let x=0; x<mapSize; x++) {
            let div = document.createElement('div');
            let type = grid[y][x];
            let className = 'cell ';
            
            if(type === '#') className += 'wall';
            else if(type === 'T') className += 'target';
            else className += 'floor';
            
            if(x === playerPos.x && y === playerPos.y) className += ' player';
            
            let boxIdx = window.currentBoxes.findIndex(b => b.x === x && b.y === y);
            if(boxIdx !== -1) {
                if(type === 'T') className += ' box-on-target';
                else className += ' box';
            }
            
            div.className = className;
            container.appendChild(div);
        }
    }
    
    document.getElementById('status').innerText = `æ­¥æ•¸: ${moveCount} | Level: ${new Date().toLocaleDateString()} [${currentDiff}]`;
    checkWin();
}

function movePlayer(dx, dy) {
    // æª¢æŸ¥æ˜¯å¦å·²å‹åˆ©
    let allOnTarget = window.currentBoxes.every(b => grid[b.y][b.x] === 'T');
    if(allOnTarget) return;

    const nextX = playerPos.x + dx;
    const nextY = playerPos.y + dy;
    
    if(grid[nextY][nextX] === '#') return; 

    let boxIdx = window.currentBoxes.findIndex(b => b.x === nextX && b.y === nextY);
    
    if(boxIdx !== -1) {
        // æ¨ç®±å­
        const boxNextX = nextX + dx;
        const boxNextY = nextY + dy;
        
        // ç®±å­å‰é¢æ˜¯ç‰†æˆ–å¦ä¸€å€‹ç®±å­
        if(grid[boxNextY][boxNextX] === '#' || window.currentBoxes.some((b, i) => i !== boxIdx && b.x === boxNextX && b.y === boxNextY)) {
            return;
        }
        
        // ç§»å‹•ç®±å­
        window.currentBoxes[boxIdx].x = boxNextX;
        window.currentBoxes[boxIdx].y = boxNextY;
    }
    
    // ç§»å‹•ç©å®¶
    playerPos.x = nextX;
    playerPos.y = nextY;
    moveCount++;
    render();
}

function checkWin() {
    let allOnTarget = window.currentBoxes.every(b => grid[b.y][b.x] === 'T');
    if(allOnTarget) {
        document.getElementById('status').innerText = `ğŸ‰ æ­å–œå®Œæˆï¼ç¸½æ­¥æ•¸: ${moveCount}`;
        document.getElementById('status').style.color = "#2ecc71";
    } else {
        document.getElementById('status').style.color = "#f1c40f";
    }
}

// éµç›¤æ§åˆ¶
document.addEventListener('keydown', (e) => {
    let dx = 0;
    let dy = 0;
    if(e.key === 'ArrowUp' || e.key === 'w') dy = -1;
    else if(e.key === 'ArrowDown' || e.key === 's') dy = 1;
    else if(e.key === 'ArrowLeft' || e.key === 'a') dx = -1;
    else if(e.key === 'ArrowRight' || e.key === 'd') dx = 1;
    
    if (dx !== 0 || dy !== 0) {
        e.preventDefault(); // é˜»æ­¢é é¢æ»¾å‹•
        movePlayer(dx, dy);
    }
});

// å•Ÿå‹•éŠæˆ²
setDifficulty('NORMAL'); // é è¨­å•Ÿå‹•æ™®é€šæ¨¡å¼

</script>
</body>
</html>